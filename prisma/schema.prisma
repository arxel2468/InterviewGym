generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  name               String?
  avatarUrl          String?   @map("avatar_url")
  targetRole         String?   @map("target_role")
  interviewTimeline  String?   @map("interview_timeline")
  onboardingComplete Boolean   @default(false) @map("onboarding_complete")
  totalSessions      Int       @default(0) @map("total_sessions")
  currentStreak      Int       @default(0) @map("current_streak")
  longestStreak      Int       @default(0) @map("longest_streak")
  lastSessionAt      DateTime? @map("last_session_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  resume             Resume?
  sessions           Session[]
  subscription       Subscription?

  @@index([email])
  @@index([lastSessionAt])
  @@map("users")
}

model Resume {
  id         String   @id @default(uuid())
  userId     String   @unique @map("user_id")
  fileUrl    String   @map("file_url")
  fileName   String   @map("file_name")
  rawText    String?  @map("raw_text")
  parsedData Json?    @map("parsed_data")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("resumes")
}

model Session {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  interviewType   String    @map("interview_type")
  difficulty      String
  status          String    @default("in_progress")
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  durationSeconds Int?      @map("duration_seconds")
  usedResume      Boolean   @default(false) @map("used_resume")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  targetRole      String?   @map("target_role")
  feedback        Feedback?
  messages        Message[]
  metrics         Metrics?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobDescriptionContext Json? @map("job_description_context")

  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([userId, completedAt])
  @@index([userId, startedAt])
  @@map("sessions")
}

model Message {
  id              String   @id @default(uuid())
  sessionId       String   @map("session_id")
  role            String
  content         String
  durationMs      Int      @map("duration_ms")
  fillerWordCount Int?     @map("filler_word_count")
  pauseCount      Int?     @map("pause_count")
  longestPauseMs  Int?     @map("longest_pause_ms")
  wordCount       Int?     @map("word_count")
  orderIndex      Int      @map("order_index")
  createdAt       DateTime @default(now()) @map("created_at")
  session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, orderIndex])
  @@index([sessionId, role])
  @@map("messages")
}

model Metrics {
  id                String   @id @default(uuid())
  sessionId         String   @unique @map("session_id")
  totalFillerWords  Int      @default(0) @map("total_filler_words")
  totalPauses       Int      @default(0) @map("total_pauses")
  longestPauseMs    Int      @default(0) @map("longest_pause_ms")
  averageResponseMs Int      @default(0) @map("average_response_ms")
  totalWordCount    Int      @default(0) @map("total_word_count")
  questionsAnswered Int      @default(0) @map("questions_answered")
  clarityScore      Int?     @map("clarity_score")
  structureScore    Int?     @map("structure_score")
  relevanceScore    Int?     @map("relevance_score")
  confidenceScore   Int?     @map("confidence_score")
  overallScore      Int?     @map("overall_score")
  createdAt         DateTime @default(now()) @map("created_at")
  session           Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([overallScore])
  @@map("metrics")
}

model Feedback {
  id                String   @id @default(uuid())
  sessionId         String   @unique @map("session_id")
  strengths         Json
  improvements      Json
  suggestions       Json
  summary           String
  helpfulnessRating Int?     @map("helpfulness_rating")
  createdAt         DateTime @default(now()) @map("created_at")
  session           Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("feedbacks")
}

model ModelCache {
  id          String   @id @default("singleton")
  sttModels   Json     @map("stt_models")
  ttsModels   Json     @map("tts_models")
  chatModels  Json     @map("chat_models")
  rawModels   Json     @map("raw_models")
  lastUpdated DateTime @map("last_updated")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("model_cache")
}

model Subscription {
  id                 String    @id @default(uuid())
  userId             String    @unique @map("user_id")
  plan               String    // 'free' | 'student' | 'pro'
  status             String    // 'active' | 'cancelled' | 'expired' | 'past_due'
  razorpayCustomerId String?   @map("razorpay_customer_id")
  razorpaySubId      String?   @unique @map("razorpay_subscription_id")
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime  @map("current_period_end")
  cancelledAt        DateTime? @map("cancelled_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

model Payment {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")
  subscriptionId      String?  @map("subscription_id")
  razorpayPaymentId   String?  @unique @map("razorpay_payment_id")
  razorpayOrderId     String?  @map("razorpay_order_id")
  amount              Int      // in paise (â‚¹149 = 14900)
  currency            String   @default("INR")
  status              String   // 'created' | 'captured' | 'failed' | 'refunded'
  createdAt           DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([status])
  @@map("payments")
}
